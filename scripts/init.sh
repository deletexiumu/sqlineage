#!/usr/bin/env bash
# HiicHiveIDE åˆå§‹åŒ–è„šæœ¬
# ç”¨äºé¦–æ¬¡éƒ¨ç½²å’Œç¯å¢ƒé…ç½®

set -e

echo "ğŸš€ å¼€å§‹åˆå§‹åŒ– HiicHiveIDE..."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# é€‰æ‹©ï¼ˆå¹¶é”å®šï¼‰Python è§£é‡Šå™¨ï¼šä¼˜å…ˆ python3.12ï¼Œæ— åˆ™é€€å› python3
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if command -v python3.12 >/dev/null 2>&1; then
    PY_BIN=$(command -v python3.12)
else
    PY_BIN=$(command -v python3 || true)
fi

if [ -z "$PY_BIN" ]; then
    echo "âŒ æœªæ‰¾åˆ°å¯ç”¨ Pythonï¼Œè¯·å…ˆå®‰è£… Python 3.12+"
    exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ£€æŸ¥ Python ç‰ˆæœ¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“‹ æ£€æŸ¥ Python ç‰ˆæœ¬..."
python_version=$("$PY_BIN" --version 2>&1 | awk '{print $2}')
required_version="3.8"

if [ "$(printf '%s\n' "$required_version" "$python_version" | sort -V | head -n1)" = "$required_version" ]; then
    echo "âœ… Python ç‰ˆæœ¬ç¬¦åˆè¦æ±‚: $python_version (è·¯å¾„: $PY_BIN)"
else
    echo "âŒ Python ç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦ 3.8+ï¼Œå½“å‰ç‰ˆæœ¬: $python_version"
    exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ£€æŸ¥ Node.js ç‰ˆæœ¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“‹ æ£€æŸ¥ Node.js ç‰ˆæœ¬..."
if command -v node >/dev/null 2>&1; then
    node_major=$(node -p "parseInt(require('process').versions.node.split('.')[0], 10)")
    if [ "$node_major" -ge 16 ]; then
        echo "âœ… Node.js ç‰ˆæœ¬ç¬¦åˆè¦æ±‚: $(node --version)"
    else
        echo "âŒ Node.js ç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦ 16+ï¼Œå½“å‰ç‰ˆæœ¬: $(node --version)"
        exit 1
    fi
else
    echo "âŒ æœªå®‰è£… Node.jsï¼Œè¯·å…ˆå®‰è£… Node.js 16+"
    exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ..."
if [ ! -d "venv" ]; then
    "$PY_BIN" -m venv venv
    echo "âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå®Œæˆ (Python $python_version)"
else
    echo "âš ï¸  è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ”§ æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ..."
source venv/bin/activate

# ç¼–è¯‘ sasl ä¾èµ–çš„å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼ˆæ ¹æ®ä½ çš„æœºå™¨è°ƒæ•´ï¼‰
export CFLAGS="-I/opt/homebrew/opt/cyrus-sasl/include"
export LDFLAGS="-L/opt/homebrew/opt/cyrus-sasl/lib"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å®‰è£… Python ä¾èµ–
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“¦ å®‰è£… Python ä¾èµ–..."
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn -U pip
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn -r requirements.txt
echo "âœ… Python ä¾èµ–å®‰è£…å®Œæˆ"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å®‰è£…å‰ç«¯ä¾èµ–
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
pushd frontend >/dev/null
npm install
echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"
popd >/dev/null

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ•°æ®åº“åˆå§‹åŒ–
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ—„ï¸  æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®åº“..."

# ç¡®ä¿Djangoé¡¹ç›®å­˜åœ¨
if [ ! -f "manage.py" ]; then
    echo "âŒ manage.py æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·ç¡®è®¤åœ¨æ­£ç¡®çš„é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ"
    exit 1
fi

# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "db.sqlite3" ]; then
    echo "ğŸ“„ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ•°æ®åº“..."
    # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æœªåˆ›å»ºçš„è¿ç§»æ–‡ä»¶
    echo "  - ç”Ÿæˆè¿ç§»æ–‡ä»¶..."
    "$PY_BIN" manage.py makemigrations apps_core apps_metadata apps_git apps_lineage
    echo "  - æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
    "$PY_BIN" manage.py migrate
    echo "âœ… æ•°æ®åº“åˆ›å»ºå®Œæˆ"
else
    echo "ğŸ“„ æ•°æ®åº“æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ£€æŸ¥è¿ç§»çŠ¶æ€..."
    
    # æ£€æŸ¥å„ä¸ªåº”ç”¨çš„è¿ç§»çŠ¶æ€
    migration_needed=false
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¿ç§»éœ€è¦åˆ›å»º
    if ! "$PY_BIN" manage.py makemigrations --check --dry-run >/dev/null 2>&1; then
        echo "  - æ£€æµ‹åˆ°æ¨¡å‹æ›´æ”¹ï¼Œç”Ÿæˆæ–°çš„è¿ç§»æ–‡ä»¶..."
        "$PY_BIN" manage.py makemigrations
        migration_needed=true
    fi
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æœªåº”ç”¨çš„è¿ç§»
    if [ "$("$PY_BIN" manage.py showmigrations --list | grep '\[ \]' | wc -l)" -gt 0 ]; then
        echo "  - æ£€æµ‹åˆ°æœªåº”ç”¨çš„è¿ç§»ï¼Œæ‰§è¡Œè¿ç§»..."
        migration_needed=true
    fi
    
    if [ "$migration_needed" = true ]; then
        "$PY_BIN" manage.py migrate
        echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
    else
        echo "âœ… æ•°æ®åº“çŠ¶æ€æ­£å¸¸ï¼Œæ— éœ€è¿ç§»"
    fi
fi

# åˆ›å»ºè®¤è¯Tokenè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
echo "ğŸ”‘ ç¡®ä¿è®¤è¯Tokenè¡¨å­˜åœ¨..."
"$PY_BIN" manage.py shell -c "
from django.contrib.auth.models import User
from rest_framework.authtoken.models import Token
# ä¸ºæ‰€æœ‰ç”¨æˆ·åˆ›å»ºTokenï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
for user in User.objects.all():
    Token.objects.get_or_create(user=user)
print('âœ… Tokenè¡¨æ£€æŸ¥å®Œæˆ')
" 2>/dev/null || echo "  - Tokenè¡¨å°†åœ¨é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨åˆ›å»º"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å¯é€‰ï¼šåˆ›å»ºè¶…çº§ç”¨æˆ·
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ‘¤ æ˜¯å¦åˆ›å»ºè¶…çº§ç”¨æˆ·ï¼Ÿ(y/n)"
read -r create_superuser
if [[ "$create_superuser" =~ ^[Yy]$ ]]; then
    "$PY_BIN" manage.py createsuperuser
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# åˆ›å»ºå¿…è¦çš„ç›®å½•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“ åˆ›å»ºå¿…è¦çš„ç›®å½•..."
mkdir -p logs /tmp/git_repos
chmod 755 logs /tmp/git_repos
echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ç”ŸæˆåŠ å¯†å¯†é’¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ” ç”ŸæˆåŠ å¯†å¯†é’¥..."
"$PY_BIN" - <<'PY'
from cryptography.fernet import Fernet
key = Fernet.generate_key().decode()
print("è¯·å°†ä»¥ä¸‹å¯†é’¥æ·»åŠ åˆ° settings.pyï¼š")
print(f'GIT_ENCRYPTION_KEY = "{key}"')
PY

echo
echo "ğŸ‰ HiicHiveIDE åˆå§‹åŒ–å®Œæˆï¼"
echo
echo "æ¥ä¸‹æ¥ï¼š"
echo "1ï¸âƒ£ é…ç½® hive_ide/settings.py ä¸­çš„ Hive å’Œ SQLFlow æœåŠ¡åœ°å€"
echo "2ï¸âƒ£ è¿è¡Œ './scripts/start.sh' å¯åŠ¨æœåŠ¡"
echo "3ï¸âƒ£ è®¿é—® http://localhost:8000 (åç«¯) å’Œ http://localhost:5173 (å‰ç«¯)"
echo
echo "æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ README.md"